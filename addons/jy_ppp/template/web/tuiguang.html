{template 'common/header'}
{template 'web/nav'}
<ul class="nav nav-tabs">
	<li{if $op=='tuiguang' ||$op ==''} class="active"{/if}><a href="{php echo $this->createWebUrl('tuiguang');}">推广员管理</a></li>
	<li{if $op=='edit' } class="active"{/if}><a href="{php echo $this->createWebUrl('tuiguang',array('op'=>'edit','id'=>$_GPC['id']));}">推广员编辑</a></li>
</ul>

<div class="main">
	{if $op =="edit"}
		<form action="" method="post" class="form-horizontal form" enctype="multipart/form-data">
			<div class="panel panel-info">
				<div class="panel-heading">
					推广人员管理
				</div>
				<div class="panel-body">
					{if !empty($parent)}
					<div class="form-group">
						<label class="col-xs-12 col-sm-3 col-md-2 control-label">上级推广人员</label>
						<div class="col-sm-7 col-xs-12">
							<label>{$parent['username']}</label>
						</div>
					</div>
					{/if}
					<div class="form-group">
						<label class="col-xs-12 col-sm-3 col-md-2 control-label">用户名</label>
						<div class="col-sm-7 col-xs-12">
							<input type="text" name="username" class="form-control" value="{$item['username']}" />
						</div>
					</div>
					<div class="form-group">
						<label class="col-xs-12 col-sm-3 col-md-2 control-label">手机</label>
						<div class="col-sm-7 col-xs-12">
							<input type="text" name="mobile" class="form-control" value="{$item['mobile']}" />
						</div>
					</div>
					<div class="form-group">
						<label class="col-xs-12 col-sm-3 col-md-2 control-label">邮箱</label>
						<div class="col-sm-7 col-xs-12">
							<input type="text" name="mail" class="form-control" value="{$item['mail']}" />
						</div>
					</div>
					<div class="form-group">
						<label class="col-xs-12 col-sm-3 col-md-2 control-label">QQ</label>
						<div class="col-sm-7 col-xs-12">
							<input type="text" name="QQ" class="form-control" value="{$item['QQ']}" />
						</div>
					</div>
					<div class="form-group">
						<label class="col-xs-12 col-sm-3 col-md-2 control-label">微信</label>
						<div class="col-sm-7 col-xs-12">
							<input type="text" name="wechat" class="form-control" value="{$item['wechat']}" />
						</div>
					</div>
					<div class="form-group">
						<label class="col-xs-12 col-sm-3 col-md-2 control-label">真实姓名</label>
						<div class="col-sm-7 col-xs-12">
							<input type="text" name="realname" class="form-control" value="{$item['realname']}" />
						</div>
					</div>
					<div class="form-group">
						<label class="col-xs-12 col-sm-3 col-md-2 control-label">支付宝</label>
						<div class="col-sm-7 col-xs-12">
							<input type="text" name="alipay" class="form-control" value="{$item['alipay']}" />
						</div>
					</div>
					<div class="form-group">
						<label class="col-xs-12 col-sm-3 col-md-2 control-label">密码</label>
						<div class="col-sm-7 col-xs-12">
							<input type="text" name="password" class="form-control" value="{$item['password']}" />
						</div>
					</div>
					<div class="form-group">
						<label class="col-xs-12 col-sm-3 col-md-2 control-label">备注</label>
						<div class="col-sm-7 col-xs-12">
							<textarea style="height:200px;" class="form-control" name="description" cols="70" id="description">{$item['description']}</textarea>
						</div>
					</div>
					<div class="form-group">
						<label class="col-xs-12 col-sm-3 col-md-2 control-label"></label>
						<div class="col-sm-9 col-xs-12">
							<input name="submit" type="submit" value="提交" class="btn btn-primary span3"> 
							<input type="hidden" name="token" value="{$_W['token']}" />
						</div>
					</div>
				</div>
			</div>
		</form>
	{/if}
	{if $op =="tuiguang"}
		<div class="panel panel-info">
		<div class="panel-heading">筛选</div>

		<div class="panel-body">

			<form action="./index.php" method="get" class="form-horizontal" role="form">

				<input type="hidden" name="c" value="site" />
				<input type="hidden" name="a" value="entry" />
	        	<input type="hidden" name="m" value="jy_ppp" />
	        	<input type="hidden" name="do" value="tuiguang" />

				<div class="form-group">
					<label class="col-xs-12 col-sm-2 col-md-2 col-lg-1 control-label">关键字</label>
					<div class="col-xs-12 col-sm-8 col-lg-9">
						<input class="form-control" name="keyword" id="" type="text" value="{$_GPC['keyword']}">
					</div>
				</div>

				<div class="form-group">
				 	<div class=" col-xs-12 col-sm-2 col-lg-2">

						<button class="btn btn-default"><i class="fa fa-search"></i> 搜索</button>

					</div>
				</div>
			</form>
		</div>
    	</div>

	    {if empty($list)}
		<div class="panel panel-danger">
			<div class="panel-heading">仍未有任何推广人员，请先添加推广员！</div>
		</div>
		<a href="{php echo $this->createWebUrl('tuiguang', array('op' => 'edit'))}"><div class="btn btn-success">添加新推广员</div></a>
		{else}
		<style type="text/css">
			.erweimaDiv{
				position: fixed;
				right: 0;
				top: 0;
				padding-top: 15%;
				width: 89%;
				height: 100%;
				background-color: rgba(0,0,0,0.5);
				text-align: center;
				vertical-align: middle;
				display: none;
			}
			.erweimaDiv>img{
				width: 30%;
			}
		</style>
		<div class="panel panel-default">
			<div class="panel-heading"><a href="{php echo $this->createWebUrl('tuiguang', array('op' => 'sc'))}"><div class="btn btn-success">为所有推广员生成渠道二维码</div></a></div>
			<div class="panel-body table-responsive"><span style="color:red;font-weight:bold">注意：当卸载模块重新安装模块时必须执行该按钮，否则推广员的渠道二维码将会失效！并且不能去到回复规则列表中修改或删除以推广员开始，以推广二维码结束的规则，否则会引起修改了的二维码无法正常使用！</span></div>
		</div>
		
		<div class="panel panel-info">
			<div class="panel-heading">推广人员</div>
			<div class="panel-body table-responsive">
				<form action="" method="post" onsubmit="">
				<table class="table table-hover">
					<thead class="navbar-inner">
						<tr>
							<th style="width:5%" >编号</th>
							<th style="width:10%">用户名</th>
							<th style="width:10%">微信昵称</th>
							<th style="width:10%">微信头像</th>
							<th style="width:10%">拥有下线</th>
							<th style="width:10%">链接</th>
							<th style="width:15%">手机</th>
							<th style="width:25%">操作</th>
						</tr>
					</thead>
					<tbody id="main">
						{loop $list $item}
						<tr>
						    <td>
							<p>{$item['id']}</p>
						</td>
	                	<td>
							<p>{$item['username']}</p>
	                	</td>
	                	<td>
							<p>{$item['nickname']}</p>
	                	</td>
	                	<td>
							<img style="width:70px" src="{$item['avatar']}"/>
	                	</td>
	                	<td>
							<p>{$item['num']}</p>
						</td>
						<td style="white-space:normal;word-break:break-all">
							<p>{$url[$item['id']]}</p>
						</td>
						<td>
							<p>{$item['mobile']}</p>
						</td>
						<td>
								<a href="{php echo $this->createWebUrl('send', array('mid'=> $item['id']))}"><div class="btn btn-warning btn-sm">发信</div></a>&nbsp;<div class="btn btn-default btn-sm" onclick="qrcode2('{php echo urlencode($item['qrcode'])}')">二维码</div>&nbsp;{if empty($item['uid'])}<div class="btn btn-warning btn-sm" onclick="qrcode({$item['id']})">绑定</div>{else}<a href="{php echo $this->createWebUrl('unbind2', array('id'=>$item['id']))}"><div class="btn btn-danger btn-sm">解绑</div></a>{/if}&nbsp;<a href="{php echo $this->createWebUrl('tuiguang', array('op' => 'edit','id'=> $item['id']))}"><div class="btn btn-info btn-sm">编辑</div></a>&nbsp;<a onclick="return confirm('确认要添加子推广员，确认吗？'); return false;" href="{php echo $this->createWebUrl('tuiguang', array('op' => 'edit','parentid' => $item['id']))}"><div class="btn btn-success btn-sm">添加子推广员</div></a>&nbsp;<a onclick="return confirm('此操作不可恢复，确认吗？'); return false;" href="{php echo $this->createWebUrl('tuiguang', array('op' => 'del','id' => $item['id']))}"><div class="btn btn-danger btn-sm">删除</div></a>
						</td>
						</tr>
							{loop $children[$item['id']] $row}
							<tr>
								<td><p>{$row['id']}</p></td>
								<td class="text-left"><p style="padding-left:50px;height:30px;line-height:30px;background:url('./resource/images/bg_repno.gif') no-repeat -245px -545px;color:#3366cc" class="span1"  >{$row['username']}</p></td>
								<td><p>{$row['nickname']}</p></td>
								<td>
									<img style="width:70px" src="{$row['avatar']}"/>
			                	</td>
			                	<td><p>{$row['num']}</p></td>
			                	<td style="white-space:normal;word-break:break-all">
									<p>{$url[$row['id']]}</p>
								</td>
			                	<td><p>{$row['mobile']}</p></td>
								<td>
									<a href="{php echo $this->createWebUrl('send', array('mid'=> $row['id']))}"><div class="btn btn-warning btn-sm">发信</div></a>&nbsp;<div class="btn btn-default btn-sm" onclick="qrcode2('{php echo urlencode($row['qrcode'])}')">二维码</div>&nbsp;{if empty($row['uid'])}<div class="btn btn-warning btn-sm" onclick="qrcode({$row['id']})">绑定</div>{else}<a href="{php echo $this->createWebUrl('unbind2', array('id'=>$row['id']))}"><div class="btn btn-danger btn-sm">解绑</div></a>{/if}&nbsp;<a href="{php echo $this->createWebUrl('tuiguang', array('op' => 'edit','id'=> $row['id']))}"><div class="btn btn-info btn-sm">编辑</div></a>&nbsp;<a onclick="return confirm('此操作不可恢复，确认吗？'); return false;" href="{php echo $this->createWebUrl('tuiguang', array('op' => 'del','id' => $row['id']))}"><div class="btn btn-danger btn-sm">删除</div></a>
								</td>
							</tr>
							{/loop}
						{/loop}
					</tbody>
				</table>
				</form>
			</div>
		</div>
		<div id="code" class="erweimaDiv"></div>
		<script type="text/javascript" src="../addons/jy_ppp/js/jquery.js"></script>
		<script type="text/javascript" src="../addons/jy_ppp/js/jquery.qrcode.js"></script>

		<script>
			function qrcode(dyid)
			{
				jQuery(function(){
			        jQuery('#code').qrcode("{php echo $_W['siteroot'].'app/'.substr($this->createMobileUrl('tgybind'),2).'&id='}"+dyid);
			    })
			    $(".erweimaDiv").fadeIn(500);
			}
		   $(".erweimaDiv").bind("click",function(){
		   		$(this).fadeOut(500).html("");
		   })
		   function qrcode2(tgid)
			{
				// jQuery(function(){
			 //        jQuery('#code').qrcode("{php echo $_W['siteroot'].'app/'.substr($this->createMobileUrl('index'),2).'&tgid='}"+tgid);
			 //    })
			 	if(tgid)
			 	{
			 		$(".erweimaDiv").html('<img src="https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket='+tgid+'" >');
			    	$(".erweimaDiv").fadeIn(500);
			 	}
			 	else
			 	{
			 		alert("该推广员仍未生成渠道二维码，请先点击编辑后，再返回查看！");
			 	}
			}
		</script>
		{/if}
	{/if}

</div>

{template 'common/footer'}